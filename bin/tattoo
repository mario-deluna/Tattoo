#!/usr/bin/env php
<?php 
/*
 *---------------------------------------------------------------
 * Tattoo runner
 *---------------------------------------------------------------
 *
 * This is the tattoo command line interface
 */

use Tattoo\Tattoo; 

// we dont need the first argument
array_shift( $argv );

// if no more arguments are left print out the help
if ( empty( $argv ) ) 
{
	echo 
"
+---------------------------------------------+
| Tattoo, the hyper text programming language |
+---------------------------------------------+

 - [compile] compiles some tattoo code into php
   php bin/tattoo compile <file> <target>

"; die;
}

require 'vendor/autoload.php';

$command = array_shift( $argv );

if ( $command == 'compile' ) 
{
	$phpCode = Tattoo::compile( file_get_contents( array_shift( $argv ) ) );
	
	if ( $target = @array_shift( $argv ) )
	{
		file_put_contents( __DIR__.'/../cache/'.$target, "<?php require __DIR__ . '/../vendor/autoload.php';\n\n".$phpCode."\necho '\n';" );
	}
	else
	{
		echo $phpCode;
	}
}
elseif ( $command === 'run' )
{
	$source =  __DIR__ . '/../' . array_shift($argv);
	$cache = basename($source).'.php';

	exec('/usr/bin/php ' . __DIR__ . '/tattoo compile ' . $source . ' ' . $cache);

	ob_start();
	require __DIR__.'/../cache/' . $cache;
	$buffer = ob_get_clean();

	$dom = new DOMDocument();
    $dom->preserveWhiteSpace = false;
    $dom->loadHTML($buffer, LIBXML_HTML_NOIMPLIED | LIBXML_HTML_NODEFDTD);
    $dom->formatOutput = true;
    echo $dom->saveHTML();
}
else
{
	echo "Unknown command '".$command."'\n";
}